<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Formación · Excelencia en el Servicio</title>
<style>
:root{
  --bg:#f7f9fc;--card:#fff;--ink:#0f172a;--muted:#475569;
  --brand:#0b5faf;--brand2:#00b0ff;
  --shadow:0 10px 25px rgba(2,6,23,.08),0 3px 8px rgba(2,6,23,.05)
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
header{background:#fff;box-shadow:var(--shadow);padding:18px 16px;margin-bottom:18px}
.intro{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:16px}
.intro h1{margin:0 0 6px;font-size:28px;color:#0f3a77}
.gold{height:8px;background:linear-gradient(90deg,#c08a2e,#f0c24b,#00b0ff);border-radius:6px;margin-top:12px}

.container{max-width:1100px;margin:0 auto;padding:0 16px 30px}
.grid{display:grid;grid-template-columns:320px 1fr;gap:20px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:#fff;border-radius:18px;box-shadow:var(--shadow)}
.panel{padding:18px}
.muted{color:#475569}

.pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;font-size:12px}
.pill.basico{background:#e8fff1;color:#14532d}
.pill.intermedio{background:#eef2ff;color:#1e3a8a}
.pill.avanzado{background:#fff1f2;color:#7f1d1d}

input,select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font-size:15px}
button{border:0;border-radius:12px;padding:10px 14px;font-weight:600;font-size:14px;background:#0b5faf;color:#fff;box-shadow:var(--shadow);cursor:pointer}
button.secondary{background:#e5e7eb;color:#111827;box-shadow:none}
button.ghost{background:transparent;color:#0b5faf;box-shadow:none}

.progress-wrap{margin-top:12px}
.progress-track{height:7px;border-radius:999px;background:#e5e7eb;overflow:hidden}
.progress-bar{height:100%;width:0;border-radius:999px;background:linear-gradient(90deg,#0b5faf,#00b0ff);transition:width .3s ease}

.small{font-size:13px;color:#64748b;margin-top:8px}
.small b{color:#0f172a}

/* Panel principal pregunta */
.question{padding:18px 20px;border-bottom:1px solid #e5e7eb;font-size:17px;font-weight:600}
.qmeta{display:flex;align-items:center;gap:8px;margin:0 0 6px}
.qid{font:12px/1 ui-monospace,Consolas,Menlo;background:#eef2ff;color:#312e81;padding:3px 7px;border-radius:8px;border:1px solid #c7d2fe}

.answers{display:grid;gap:10px}
.answer{
  display:grid; grid-template-columns:22px 28px 1fr;
  align-items:center;
  gap:12px; border:1px solid #e5e7eb; border-radius:14px; padding:12px;
  background:#fff; cursor:pointer; text-align:left;
}
.answer input{width:18px;height:18px;margin:0}
.letter{min-width:28px;height:24px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px;font-size:13px;font-weight:600;background:#f1f5f9;color:#0f172a}
.answer.correct .letter{background:#dcfce7;color:#166534}
.answer.wrong .letter{background:#fee2e2;color:#991b1b}
.answer.disabled{opacity:.7;cursor:default}

.explain{margin-top:12px;padding:12px 14px;border-radius:12px;background:#f9fafb;border:1px solid #e5e7eb;font-size:14px;color:#1f2933}
.explain.ok{color:#166534;background:#f0fdf4;border-color:#86efac}
.explain.bad{color:#991b1b;background:#fef2f2;border-color:#fecaca}
.explain small{display:block;color:#334155;opacity:.95;margin-top:6px}

table{width:100%;border-collapse:collapse}
th,td{padding:10px 8px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px}
th{font-weight:700;color:#334155}

.finalmsg{margin-top:20px;padding:20px;border-radius:16px;border:1px solid #e5e7eb;background:#f9fafb;font-size:16px;line-height:1.5;box-shadow:0 4px 15px rgba(0,0,0,.05)}
.finalmsg.ok{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-color:#86efac;color:#14532d}
.finalmsg.warn{background:linear-gradient(135deg,#fffbe6,#fef9c3);border-color:#fde68a;color:#78350f}
.finalmsg.bad{background:linear-gradient(135deg,#fef2f2,#fee2e2);border-color:#fecaca;color:#7f1d1d}

/* Ajustes extra para móviles pequeños */
@media (max-width: 600px){
  body{font-size:16px;}
  header{padding:12px 10px;margin-bottom:12px;}
  .intro{flex-direction:column;align-items:flex-start;gap:10px;}
  .intro h1{font-size:22px;}
  .container{padding:0 12px 24px;}
  .grid{gap:14px;}
  .card{border-radius:16px;}
  .panel{padding:14px 12px;}
  input,select{font-size:16px;padding:11px 12px;}
  button{font-size:15px;padding:11px 14px;}
  .question{padding:14px 12px;margin:14px 0;font-size:16px;}
  .answers{gap:8px;}
  .answer{grid-template-columns:22px 26px 1fr;padding:10px 10px;}
}
</style>
</head>
<body>
<header>
  <div class="intro">
    <div>
      <h1>Formación · Excelencia en el Servicio</h1>
      <div class="gold"></div>
    </div>
  </div>
</header>

<div class="container">
  <div class="grid">
    <aside class="card panel">
      <h3 style="margin:0 0 8px">1) Identificación</h3>
      <p class="muted">Tu nombre es obligatorio para participar y aparecer en el ranking.</p>
      <input id="playerName" placeholder="Nombre y apellidos (obligatorio)">
      <hr style="border:0;border-top:1px solid #e5e7eb;margin:14px 0">

      <h3 style="margin:0 0 8px">2) Departamento</h3>
      <select id="deptSelect"><option value="">Todos los departamentos</option></select>
      <p class="small">Usamos esta información para agrupar resultados y detectar necesidades de refuerzo por área.</p>

      <hr style="border:0;border-top:1px solid #e5e7eb;margin:14px 0">

      <h3 style="margin:0 0 8px">3) Módulo de formación</h3>
      <select id="moduleSelect"><option value="">Selecciona un módulo…</option></select>

      <div id="moduleInfo" style="margin-top:10px;display:none">
        <span id="moduleLevelPill" class="pill basico"></span>
        <p id="moduleDesc" class="small" style="margin-top:8px"></p>
      </div>

      <div id="moduleStats" style="margin-top:10px;display:none">
        <div class="progress-wrap">
          <div class="progress-track">
            <div class="progress-bar" id="progressBar"></div>
          </div>
        </div>
        <p class="small" id="moduleStatText"></p>
      </div>

      <hr style="border:0;border-top:1px solid #e5e7eb;margin:14px 0">

      <h3 style="margin:0 0 8px">4) Dificultad</h3>
      <select id="levelSelect">
        <option value="">Selecciona nivel…</option>
      </select>
      <p class="small">Los niveles agrupan preguntas por complejidad. Puedes repetir el test tantas veces como quieras.</p>

      <hr style="border:0;border-top:1px solid #e5e7eb;margin:14px 0">

      <button id="startBtn" style="width:100%;margin-bottom:8px">Empezar test</button>
      <button id="restartBtn" class="secondary" style="width:100%;display:none">Reiniciar</button>

      <p id="status" class="small" style="margin-top:10px;display:none"></p>
    </aside>

    <main class="card">
      <div class="question">
        <div class="qmeta">
          <span class="qid" id="qId">—</span>
          <span class="muted" id="qModule">Selecciona módulo y nivel para comenzar</span>
        </div>
        <div id="qText">Pregunta de ejemplo: pulsa “Empezar test” cuando hayas elegido módulo y nivel.</div>
      </div>

      <div style="padding:18px 20px">
        <div class="answers" id="answers"></div>
        <div class="explain" id="why" style="display:none"></div>

        <div id="finalMsg" class="finalmsg" style="display:none"></div>

        <div style="display:flex;gap:8px;margin-top:16px;justify-content:space-between;align-items:center">
          <button id="nextBtn" style="flex:1;display:none">Siguiente pregunta</button>
          <button id="finishBtn" class="secondary" style="display:none;white-space:nowrap">Finalizar</button>
          <button id="skipBtn" class="ghost" style="display:none;white-space:nowrap">Saltar</button>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
const INDEX_JSON = "data/index.json";
const AGG_JSON   = "data/agg.json";

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

let INDEX = null;
let AGG   = null;

let currentModule = null;
let currentLevel  = null;
let questions = [];
let currentIndex = 0;
let correctCount = 0;
let totalQuestions = 30;

let answered = false;
let startTime = null;
let endTime   = null;

async function loadIndex(){
  const res = await fetch(INDEX_JSON+"?v="+Date.now());
  if(!res.ok) throw new Error("No se puede cargar index.json");
  INDEX = await res.json();

  const resAgg = await fetch(AGG_JSON+"?v="+Date.now());
  AGG = await resAgg.json();

  fillSelectors();
}

function fillSelectors(){
  const deptSel = $("#deptSelect");
  const modSel  = $("#moduleSelect");
  const levelSel= $("#levelSelect");

  const depts = new Set();
  const levels = new Set();

  Object.values(INDEX.modules).forEach(mod=>{
    (mod.departments||[]).forEach(d=>depts.add(d));
    Object.keys(mod.levels||{}).forEach(l=>levels.add(l));
  });

  for(const d of Array.from(depts).sort()){
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    deptSel.appendChild(opt);
  }

  Object.entries(INDEX.modules).sort((a,b)=>a[1].order-b[1].order).forEach(([id,mod])=>{
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = mod.name;
    modSel.appendChild(opt);
  });

  const LEVEL_LABELS = INDEX.level_labels || {};
  Array.from(levels).sort().forEach(l=>{
    const opt = document.createElement("option");
    opt.value = l;
    opt.textContent = LEVEL_LABELS[l] || ("Nivel "+l);
    levelSel.appendChild(opt);
  });

  $("#moduleSelect").addEventListener("change", onModuleChange);
  $("#levelSelect").addEventListener("change", preloadAggAndDepartments);
}

function onModuleChange(){
  const modId = $("#moduleSelect").value;
  if(!modId){ 
    $("#moduleInfo").style.display="none";
    $("#moduleStats").style.display="none";
    return;
  }

  currentModule = modId;
  const mod = INDEX.modules[modId];

  const level = $("#levelSelect").value;
  currentLevel = level || null;

  const pill = $("#moduleLevelPill");
  pill.className = "pill basico";
  const type = (mod.type || "basico").toLowerCase();
  if(type==="intermedio") pill.className="pill intermedio";
  else if(type==="avanzado") pill.className="pill avanzado";

  $("#moduleDesc").textContent = mod.description || "";
  $("#moduleInfo").style.display="block";

  preloadAggAndDepartments();
}

async function preloadAggAndDepartments(){
  const mod = $("#moduleSelect").value;
  const lvl = $("#levelSelect").value;
  const info = INDEX?.[mod]?.levels?.[lvl];
  if(!mod || !info){ return; }
  try{
    const res = await fetch(AGG_JSON+"?v="+Date.now());
    if(!res.ok) throw new Error("No se puede cargar agg.json");
    AGG = await res.json();
    updateModuleStats(mod,lvl);
  }catch(e){
    console.error(e);
  }
}

function updateModuleStats(modId,level){
  if(!AGG || !AGG.modules || !AGG.modules[modId] || !AGG.modules[modId].levels[level]) return;
  const data = AGG.modules[modId].levels[level];
  const pct = data.avg_correct || 0;
  const n   = data.responses || 0;

  const bar = $("#progressBar");
  bar.style.width = Math.round(pct)+"%";

  const txt = $("#moduleStatText");
  txt.textContent = `Media de aciertos: ${pct.toFixed(1)}% · Participaciones: ${n}`;

  $("#moduleStats").style.display="block";
}

function buildQuestionPool(){
  const modId = $("#moduleSelect").value;
  const lvl   = $("#levelSelect").value;
  const dept  = $("#deptSelect").value;

  if(!modId || !lvl){
    alert("Selecciona módulo y nivel para empezar.");
    return false;
  }

  currentModule = modId;
  currentLevel  = lvl;

  const mod = INDEX.modules[modId];
  const pool = (mod.questions || []).filter(q=>{
    if(q.level!=lvl) return false;
    if(dept && q.departments && !q.departments.includes(dept)) return false;
    return true;
  });

  if(pool.length===0){
    alert("No hay preguntas para esa combinación. Prueba otro nivel o departamento.");
    return false;
  }

  shuffle(pool);
  questions = pool.slice(0, totalQuestions);
  currentIndex = 0;
  correctCount = 0;
  answered = false;
  startTime = Date.now();
  endTime   = null;

  $("#finalMsg").style.display="none";
  $("#why").style.display="none";
  $("#nextBtn").style.display="inline-flex";
  $("#finishBtn").style.display="none";
  $("#skipBtn").style.display="inline-flex";

  renderQuestion();
  return true;
}

function renderQuestion(){
  const q = questions[currentIndex];
  if(!q) return;

  $("#qId").textContent = q.id || `Q${currentIndex+1}`;
  $("#qModule").textContent = INDEX.modules[currentModule].name+" · Nivel "+currentLevel;
  $("#qText").textContent = q.text;

  const answers = $("#answers");
  answers.innerHTML = "";

  const opts = [...q.options];
  shuffle(opts);

  opts.forEach(opt=>{
    const label = document.createElement("label");
    label.className="answer";
    const wrap = document.createElement("div");

    const radio = document.createElement("input");
    radio.type="radio";
    radio.name="answer";
    radio.value=opt.key;

    const letter = document.createElement("span");
    letter.className="letter";
    letter.textContent=opt.key.toUpperCase();

    const span = document.createElement("span");
    span.textContent = opt.text;

    label.appendChild(radio);
    label.appendChild(letter);
    label.appendChild(span);
    answers.appendChild(label);

    label.addEventListener("click",()=>onAnswer(q,opt, label));
  });

  $("#why").style.display="none";
  answered = false;
}

function onAnswer(q, opt, labelEl){
  if(answered) return;
  answered = true;

  const isCorrect = opt.key === q.correct;
  if(isCorrect) correctCount++;

  $$(".answer").forEach(el=>{
    el.classList.add("disabled");
    const radio = el.querySelector("input");
    if(radio && radio.value===q.correct){
      el.classList.add("correct");
    }else if(radio && el===labelEl && !isCorrect){
      el.classList.add("wrong");
    }
  });

  const explain = $("#why");
  explain.style.display="block";
  explain.classList.remove("ok","bad");

  if(isCorrect){
    explain.classList.add("ok");
    explain.innerHTML = `<b>¡Correcto!</b><small>${q.explain||"Buen trabajo, sigue así."}</small>`;
  }else{
    explain.classList.add("bad");
    explain.innerHTML = `<b>No es la mejor opción.</b><small>${q.explain||"Revisa el procedimiento asociado en el manual para reforzarlo."}</small>`;
  }

  if(currentIndex===questions.length-1){
    $("#nextBtn").style.display="none";
    $("#finishBtn").style.display="inline-flex";
  }else{
    $("#nextBtn").style.display="inline-flex";
    $("#finishBtn").style.display="none";
  }
}

function finishTest(){
  endTime = Date.now();
  const elapsedSec = (endTime-startTime)/1000;
  const pct = (correctCount/questions.length)*100;

  const box = $("#finalMsg");
  box.style.display="block";
  box.classList.remove("ok","warn","bad");

  let cls = "ok";
  if(pct<50) cls="bad";
  else if(pct<80) cls="warn";
  box.classList.add(cls);

  box.innerHTML = `
    <strong>Resultado final</strong><br>
    Has acertado ${correctCount} de ${questions.length} preguntas (${pct.toFixed(1)}%).<br>
    Tiempo empleado: ${elapsedSec.toFixed(1)} segundos.
  `;

  $("#nextBtn").style.display="none";
  $("#finishBtn").style.display="none";
  $("#skipBtn").style.display="none";
}

function nextQuestion(){
  if(!answered){
    if(!confirm("¿Seguro que quieres pasar sin responder?")) return;
  }
  currentIndex++;
  if(currentIndex>=questions.length){
    finishTest();
  }else{
    renderQuestion();
  }
}

function skipQuestion(){
  if(!confirm("Esta pregunta contará como no respondida. ¿Continuar?")) return;
  nextQuestion();
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}

$("#startBtn").addEventListener("click", ()=>{
  if(!$("#playerName").value.trim()){
    alert("Indica tu nombre para continuar.");
    return;
  }
  if(buildQuestionPool()){
    $("#status").style.display="none";
  }
});

$("#restartBtn").addEventListener("click", ()=>{
  buildQuestionPool();
});

$("#nextBtn").addEventListener("click", nextQuestion);
$("#finishBtn").addEventListener("click", finishTest);
$("#skipBtn").addEventListener("click", skipQuestion);

loadIndex().catch(e=>{
  console.error(e);
  $("#status").style.display="block";
  $("#status").textContent="No se pudo cargar el índice de datos.";
});
</script>
</body>
</html>
