<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FormaciÃ³n Â· Excelencia en el Servicio</title>
<style>
  body{font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0;color:#1f2937;}
  header{padding:16px 24px;border-bottom:1px solid #e5e7eb;background:#fff}
  header h1{margin:0 0 4px;font:800 28px/1.2 'Montserrat',Arial,Helvetica,sans-serif;color:#0f3a77}
  header p{margin:0;color:#4b5563;font-style:italic}
  .bar{height:10px;background:linear-gradient(90deg,#0f3a77,#1d8bb7,#a2c86b);border-radius:999px;margin-top:12px}
  .wrap{display:grid;grid-template-columns:340px 1fr;gap:16px;max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.04)}
  aside.card{padding:16px}
  main.card{padding:16px;min-height:300px}
  h2{font-size:18px;margin:12px 0}
  label{display:block;margin:10px 0 6px;color:#374151;font-weight:600}
  select,input{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff}
  button.primary{margin-top:12px;background:#0f3a77;color:#fff;border:none;border-radius:12px;padding:10px 16px;font-weight:700;box-shadow:0 4px 0 rgba(15,58,119,.2)}
  .muted{color:#6b7280}
  table{width:100%;border-collapse:collapse;margin-top:6px}
  th,td{text-align:left;padding:8px;border-bottom:1px solid #f0f2f6}
  th{font-size:12px;color:#6b7280;font-weight:600}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef7ff;color:#0f3a77;font-weight:600;font-size:12px}
</style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:16px;justify-content:space-between">
      <div>
        <h1>FormaciÃ³n Interna Â· Excelencia en el Servicio</h1>
        <p>Enfocada en la excelencia operativa â€” Hoteles Guadiana & Cumbria</p>
        <div class="bar"></div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <aside class="card">
      <h2>1) IdentificaciÃ³n</h2>
      <input id="username" placeholder="Nombre y apellidos (obligatorio)">

      <h2>2) Departamento</h2>
      <select id="deptSelect">
        <option value="">Todos los departamentos</option>
      </select>

      <h2>3) MÃ³dulo y nivel</h2>
      <label for="moduleSelect">MÃ³dulo</label>
      <select id="moduleSelect"><option value="">Selecciona mÃ³duloâ€¦</option></select>

      <label for="levelSelect">Nivel</label>
      <select id="levelSelect">
        <option value="basico">Nivel BÃ¡sico ðŸŸ¢</option>
        <option value="intermedio">Nivel Intermedio ðŸŸ¡</option>
        <option value="avanzado">Nivel Avanzado ðŸ”´</option>
      </select>

      <button class="primary" id="startBtn">Comenzar</button>

      <h2>ðŸ† Ranking</h2>
      <table id="ranking">
        <thead><tr><th>#</th><th>Nombre</th><th>MÃ³dulo</th><th>Punt.</th><th>Fecha</th></tr></thead>
        <tbody><tr><td colspan="5" class="muted">Sin resultados todavÃ­a.</td></tr></tbody>
      </table>
    </aside>

    <main class="card" id="stage">
      <div class="pill" id="statusPill">Selecciona opciones y pulsa â€œComenzarâ€.</div>
      <div class="muted" style="margin-top:8px">Cargaremos las preguntas desde el Excel procesado (sin CORS).</div>
    </main>
  </div>

  <!-- Index embebido para evitar fetch/CORS -->
  <script id="INDEX" type="application/json">{{"errores_comunes": {{"name": "Errores Comunes", "levels": {{"avanzado": {{"agg": "errores_comunes_avanzado.json", "blocks_dir": "errores_comunes/blocks/avanzado/", "count": 30, "block_size": 25}}}}}}, "operativa_turnos": {{"name": "Operativa Turnos", "levels": {{"avanzado": {{"agg": "operativa_turnos_avanzado.json", "blocks_dir": "operativa_turnos/blocks/avanzado/", "count": 25, "block_size": 25}}, "basico": {{"agg": "operativa_turnos_basico.json", "blocks_dir": "operativa_turnos/blocks/basico/", "count": 25, "block_size": 25}}, "intermedio": {{"agg": "operativa_turnos_intermedio.json", "blocks_dir": "operativa_turnos/blocks/intermedio/", "count": 25, "block_size": 25}}}}}}, "reservas": {{"name": "Reservas", "levels": {{"avanzado": {{"agg": "reservas_avanzado.json", "blocks_dir": "reservas/blocks/avanzado/", "count": 35, "block_size": 25}}, "basico": {{"agg": "reservas_basico.json", "blocks_dir": "reservas/blocks/basico/", "count": 25, "block_size": 25}}, "intermedio": {{"agg": "reservas_intermedio.json", "blocks_dir": "reservas/blocks/intermedio/", "count": 15, "block_size": 25}}}}}}, "departments": ["RecepciÃ³on"]}}</script>

  <script>
    const $ = (id)=>document.getElementById(id);
    const INDEX = JSON.parse(document.getElementById('INDEX').textContent);

    // Poblar mÃ³dulos
    const moduleMap = Object.fromEntries(Object.entries(INDEX).map(([k,v])=>[k, v.name]));
    const moduleSelect = $('moduleSelect');
    for (const [key,name] of Object.entries(moduleMap)) { 
      const opt = document.createElement('option'); opt.value=key; opt.textContent=name; moduleSelect.appendChild(opt);
    }

    // Poblar departamentos (si existen)
    const depts = INDEX.departments || [];
    const deptSelect = $('deptSelect');
    depts.forEach(d=>{ const o=document.createElement('option'); o.value=d; o.textContent=d; deptSelect.appendChild(o); });

    $('startBtn').addEventListener('click', async()=>{ 
      const user = $('username').value.trim();
      if(!user){ alert('Escribe tu nombre.'); return; }
      const mod = moduleSelect.value;
      const lvl = $('levelSelect').value;
      if(!mod){ alert('Selecciona un mÃ³dulo.'); return; }
      const info = INDEX[mod]?.levels?.[lvl];
      if(!info){ alert('No hay preguntas para este nivel.'); return; }

      try{
        const res = await fetch('./data/' + info.agg);
        const all = await res.json();
        // Filtrar por departamento si procede
        const dto = deptSelect.value;
        const preguntas = dto ? all.filter(q => (q.dto||'').trim()===dto.trim()) : all;

        const stage = $('stage');
        stage.innerHTML = '<div class="pill"> '+ (INDEX[mod].name) +' Â· '+ lvl.toUpperCase() +' ('+ preguntas.length +' preguntas)</div>';
        if(preguntas.length===0){
          stage.innerHTML += '<p class="muted">No hay preguntas para el filtro seleccionado.</p>';
          return;
        }
        // Mostrar la primera pregunta como prueba visual
        const q = preguntas[0];
        stage.innerHTML += '<h2 style="margin-top:10px">'+ q.text +'</h2>';
        const ul = document.createElement('ul');
        for(let i=0;i<q.options.length;i++){ 
          const li = document.createElement('li'); li.textContent = String.fromCharCode(65+i)+') '+q.options[i]; ul.appendChild(li);
        }
        stage.appendChild(ul);
      }catch(e){
        alert('No se pudo cargar el archivo de preguntas: '+ e);
      }
    });
  </script>
</body>
</html>
