<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SesiÃ³n de Crecimiento Â· FormaciÃ³n</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#667085;--border:#e6e7eb;--primary:#0b61d6;--ring:rgba(11,97,214,.14);}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.hidden{display:none}
.wrap{max-width:1250px;margin:28px auto;padding:0 18px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 35px rgba(15,23,42,.04)}
.header{padding:18px;display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center}
.brand{display:flex;gap:18px;align-items:center}
.brand img{height:42px;object-fit:contain}
h1{margin:2px 0 0;font-size:28px;font-weight:800;letter-spacing:.2px}
.subtitle{color:#144aa7;margin-top:2px;font-style:italic}
.grid{display:grid;grid-template-columns:360px 1fr;gap:18px;margin-top:18px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.sidebar{padding:16px}
.step{display:flex;align-items:center;gap:10px;margin:8px 0 12px}
.step .num{background:#eef2ff;border:1px solid #dfe5ff;color:#0b3b8f;border-radius:999px;padding:4px 12px;font-weight:800}
.help{font-size:14px;color:var(--muted)}
label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
select,input{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;outline:none}
select:focus,input:focus{box-shadow:0 0 0 6px var(--ring);border-color:#c7d7f7}
button{padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700}
button.primary{background:var(--primary);color:#fff;border:0}
button:disabled{opacity:.55;cursor:not-allowed}
.kpis{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.kpi{background:#f1f5f9;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:13px}
.content{padding:16px}
.progress{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden}
.progress>div{height:100%;width:0;background:#80aaff;transition:width .2s ease}
.meta{display:flex;gap:10px;align-items:center;margin:10px 0 8px;color:var(--muted);font-size:14px}
.badge{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #dfe5ff;border-radius:999px;padding:4px 10px;font-size:12px}
.qbox{padding:6px 0}
.center{display:flex;align-items:center;justify-content:center;padding:28px 10px;color:var(--muted);text-align:center}
.hero{display:flex;flex-direction:column;align-items:center;gap:14px}
.hero img{max-width:220px;height:auto;opacity:.9}
.qhead{display:flex;align-items:baseline;gap:8px}
.qnum{font-weight:800;font-size:20px}
.qid{font-size:12px;color:var(--muted)}
.qtitle{font-size:22px;font-weight:800;margin:6px 0 10px}
.answers{display:grid;gap:10px;margin-top:8px}
.ans{padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer;display:flex;gap:10px;align-items:flex-start}
.ans:hover{border-color:#d7d9df;background:#fcfcff}
.ans.correct{background:#ecfdf5;border-color:#86efac}
.ans.wrong{background:#fef2f2;border-color:#fca5a5}
.explain{margin-top:12px;padding:12px;border:1px dashed #cbd5e1;border-radius:12px;background:#f8fbff}
.controls{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.footer{margin:26px auto 10px;color:var(--muted);font-size:12px;text-align:center}
.small{font-size:12px;color:var(--muted)}
/* Mensajes finales */
.note{margin:12px 0;padding:12px;border-radius:12px;border:1px solid #e6e7eb;background:#fafcff}
.note.danger{border-color:#fecaca;background:#fff5f5}
.note.warn{border-color:#fde68a;background:#fffbeb}
.note.ok{border-color:#bbf7d0;background:#f0fdf4}
.note b{display:block;margin-bottom:6px}
/* DiagnÃ³stico */
.diag{margin-top:10px;padding:10px;border:1px dashed #cbd5e1;border-radius:10px;background:#fcfdff;text-align:left;white-space:pre-wrap}
.diag b{color:#0b3b8f}
</style>
</head>
<body>
<div class="wrap">
  <div class="card header">
    <div class="brand">
      <img src="./img/logo-guadiana.png" alt="Guadiana" onerror="this.style.display='none'">
      <img src="./img/logo-cumbria.png" alt="Cumbria" onerror="this.style.display='none'">
    </div>
    <div>
      <h1>SesiÃ³n de Crecimiento Â· FormaciÃ³n</h1>
      <div class="subtitle">Cuestionario por departamento y mÃ³dulo Â· 30 preguntas aleatorias sin repetir</div>
    </div>
  </div>

  <div class="grid">
    <aside class="card sidebar">
      <div class="step"><span class="num">1</span><b>Estado</b></div>
      <div class="help">Preguntas cargadas: <b id="loaded">0</b></div>

      <div class="step"><span class="num">2</span><b>Filtros</b></div>
      <label for="dept">Departamento (DTO)</label>
      <select id="dept"><option value="">Todos</option></select>

      <label for="mod">MÃ³dulo</label>
      <select id="mod"><option value="">Todos</option></select>

      <div class="kpis" id="kpis"></div>

      <div class="step"><span class="num">3</span><b>Nombre y empezar</b></div>
      <input id="who" type="text" placeholder="Nombre y apellidos (obligatorio)">
      <div style="margin-top:12px;display:flex;gap:10px">
        <button id="btnStart" class="primary" disabled>Empezar test</button>
      </div>

      <hr style="margin:16px 0;border:none;border-top:1px dashed var(--border)">
      <div style="font-size:14px">
        <b>Â¿Por quÃ© realizamos estas pruebas?</b>
        <ul style="margin:6px 0 0 18px;padding:0">
          <li>Refuerzo del conocimiento clave</li>
          <li>EstÃ¡ndares comunes entre hoteles</li>
          <li>DetecciÃ³n de Ã¡reas de mejora</li>
          <li>Reconocer buenas prÃ¡cticas</li>
        </ul>
      </div>
    </aside>

    <section class="card content">
      <div class="progress"><div id="bar"></div></div>
      <div class="meta">
        <span class="badge" id="metaPos">0/0</span>
        <span class="badge" id="metaScore"><b>0</b> aciertos Â· <b>0</b> fallos</span>
        <span class="badge" id="metaTags"></span>
      </div>

      <div id="holder" class="qbox center">
        <div class="hero">
          <img src="./img/empty.png" alt="Test" onerror="this.src='img/empty.png'">
          <div>
            <b>Elige Departamento â†’ MÃ³dulo</b>, escribe tu nombre y pulsa <b>Empezar test</b>.<br>
            Se seleccionarÃ¡n <b>30 preguntas</b> aleatorias del mÃ³dulo evitando repetir las ya vistas.
          </div>
          <div id="loadwarn" class="small hidden"></div>
          <div id="diag" class="diag hidden"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer">Â© FormaciÃ³n interna Â· Sercotel Guadiana y Cumbria Spa&Hotel</div>
</div>

<script>
/* ======= CONFIG ======= */
const SHEET_ENDPOINT = "https://script.google.com/macros/s/AKfycby-ICzBZDkBH8agMpQa8OwSp_B1rC2tAXMMwQnKF0WSFqMoC6WQMk556_ztqmTizcn3oQ/exec";
const CSV_CANDIDATES = [
  './data/plantilla_preguntas_unica.csv',
  'data/plantilla_preguntas_unica.csv',
  '/data/plantilla_preguntas_unica.csv'
];

/* ======= helpers & refs ======= */
const $ = s => document.querySelector(s);
const loaded=$("#loaded"), dept=$("#dept"), mod=$("#mod"), who=$("#who"), btnStart=$("#btnStart");
const holder=$("#holder"), bar=$("#bar"), metaPos=$("#metaPos"), metaScore=$("#metaScore"), metaTags=$("#metaTags");
const loadwarn=$("#loadwarn"), diag=$("#diag");
function log(...a){ console.log('[DATA]',...a); }
function showDiag(msg){ diag.classList.remove('hidden'); diag.innerHTML = msg; }
function showWarn(msg){ loadwarn.classList.remove('hidden'); loadwarn.textContent = msg; }
function uniq(a){return [...new Set(a.filter(Boolean))]}
function shuffle(a){a=a.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

/* ======= CSV ======= */
function decodeSmart(buf){ try{return new TextDecoder('utf-8',{fatal:false}).decode(buf);}catch(_){}
  try{return new TextDecoder('windows-1252').decode(buf);}catch(_){}
  return ''; }
function detectDelimiter(sample){ const c={',':0,';':0,'\t':0,'|':0};
  const ls=sample.split(/\r?\n/).slice(0,6);
  for(const l of ls){ for(const k in c){ c[k]+= (l.split(k).length-1);} }
  let m=-1,b=','; for(const k in c){ if(c[k]>m){m=c[k];b=k;} } return b; }
function splitRow(line,delim){
  const out=[]; let cur='',q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i],n=line[i+1];
    if(ch==='\"'){q=!q;continue;}
    if(!q && ch===delim){out.push(cur);cur='';continue;}
    if(!q && ch==='\r' && n==='\n'){i++;out.push(cur);return out;}
    if(!q && (ch==='\n'||ch==='\r')){out.push(cur);return out;}
    cur+=ch;
  } out.push(cur); return out;
}
function parseCSV(text){
  const d=detectDelimiter(text);
  const lines=text.split(/\r?\n/).filter(x=>x.trim()!=='');
  const head=splitRow(lines[0],d).map(h=>h.trim().toLowerCase());
  return lines.slice(1).map(ln=>{ const cols=splitRow(ln,d); const o={};
    head.forEach((h,i)=>o[h]=(cols[i]??'').trim()); return o; });
}
function normalize(arr){
  const pick=(o,ks)=>{for(const k of ks){if(k in o && String(o[k]).trim()!=='') return String(o[k]);}return'';};
  const djb2=s=>{let h=5381;for(let i=0;i<s.length;i++){h=((h<<5)+h)+s.charCodeAt(i);}return(h>>>0).toString(36);};
  return arr.map(r=>{
    const o={}; Object.keys(r).forEach(k=>o[k.toLowerCase()]=r[k]);
    const dto=pick(o,['dto','departamento','dpto','depto','departamento (dto)']).trim();
    const mod=pick(o,['modulo','mÃ³dulo','module','mod','tema','bloque','unidad','categoria','categorÃ­a']).trim();
    const text=pick(o,['text','texto','pregunta','enunciado']).trim();
    const A=pick(o,['a']),B=pick(o,['b']),C=pick(o,['c']),D=pick(o,['d']);
    const corr=(pick(o,['correct_letter','correct','letra_correcta','respuesta_correcta','respuesta'])||'').toUpperCase().match(/[A-D]/)?.[0]||'';
    const why=pick(o,['why','explicacion','explicaciÃ³n','comentario','nota']);
    const activo=pick(o,['activo','activa','enabled']);
    let id=(pick(o,['id'])||'').trim(); if(!id){id=djb2([dto,mod,text].join('|'));}
    return {id,dto,mod,text,A,B,C,D,correct:corr,why,activo};
  }).filter(r=>r.text && (r.activo===''||r.activo==='1'||String(r.activo).toLowerCase()==='true'));
}
async function fetchFirst(urls){
  for(const u of urls){
    try{
      log('Intentando CSV:', u);
      const res=await fetch(u+(u.includes('?')?'&':'?')+'v='+Date.now(),{cache:'no-store'});
      if(res.ok){const buf=await res.arrayBuffer(); return decodeSmart(buf);}
      log('CSV no OK',u,res.status);
    }catch(e){ log('CSV error',u,e.message); }
  } throw new Error('CSV no encontrado en rutas candidatas');
}
function loadQUIZFallback(){
  return new Promise((resolve,reject)=>{
    const s=document.createElement('script');
    s.src='./data/data.js?v='+Date.now();
    s.onload=()=>{
      if(window.QUIZ && Array.isArray(window.QUIZ.questions) && window.QUIZ.questions.length){
        log('data.js cargado:', window.QUIZ.questions.length);
        RAW = window.QUIZ.questions.map(q=>({
          id: q.id || Math.random().toString(36).slice(2),
          dto: q.departamento||q.dto||'',
          mod: q.categoria||q.mod||'',
          text: q.texto||q.text||'',
          A:q.A,B:q.B,C:q.C,D:q.D,
          correct:(q.correct_letter||q.correct||'').toString().toUpperCase(),
          why:q.why||'',
          activo:'1'
        }));
        resolve();
      } else reject(new Error('window.QUIZ vacÃ­o o sin questions[]'));
    };
    s.onerror=()=>reject(new Error('No se pudo cargar data.js'));
    document.head.appendChild(s);
  });
}

/* ======= historial no-repetir ======= */
const LS_KEY='quiz_historial_por_modulo_v1';
function keyFor(dto,mod){return (dto||'').trim()+'||'+(mod||'').trim();}
function loadHistory(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||'{}');}catch(_){return{};} }
function saveHistory(h){ try{localStorage.setItem(LS_KEY,JSON.stringify(h));}catch(_){} }
function getUsedIds(dto,mod){const k=keyFor(dto,mod);const h=loadHistory();return new Set(Array.isArray(h[k])?h[k]:[]);}
function pushUsedIds(dto,mod,ids){const k=keyFor(dto,mod);const h=loadHistory();const arr=new Set(Array.isArray(h[k])?h[k]:[]);ids.forEach(id=>arr.add(id));h[k]=Array.from(arr).slice(-500);saveHistory(h);}

/* ======= estado test ======= */
let RAW=[], filtered=[], idx=0; let correct=new Set(), wrong=new Set(); let startTime=0;
function updateKPIs(){
  const d=dept.value||'', m=mod.value||''; const base=RAW.filter(q=>(d? q.dto===d:true)&&(m? q.mod===m:true));
  const used=getUsedIds(d,m); const avail=base.filter(q=>!used.has(q.id)).length;
  $("#kpis").innerHTML=`<span class="kpi">Banco: <b>${base.length}</b></span>
                        <span class="kpi">Disponibles: <b>${avail}</b></span>
                        <span class="kpi">Se usarÃ¡n: <b>${Math.min(30,base.length)}</b></span>`;
  btnStart.disabled=!(dept.value && mod.value && who.value.trim() && base.length>0);
}
dept.onchange=updateKPIs; mod.onchange=updateKPIs; who.oninput=updateKPIs;

function setProgress(){const pct=filtered.length?((idx+1)/filtered.length)*100:0; bar.style.width=pct.toFixed(1)+'%';
  metaPos.textContent=`${filtered.length?(idx+1):0}/${filtered.length||0}`; metaScore.innerHTML=`<b>${correct.size}</b> aciertos Â· <b>${wrong.size}</b> fallos`; }

function paint(){
  if(!filtered.length){ holder.className='qbox center'; holder.innerHTML='<div>No hay preguntas para esa combinaciÃ³n.</div>'; metaTags.textContent=''; setProgress(); return; }
  const q=filtered[idx]; holder.className='qbox';
  metaTags.innerHTML=`<span class="badge">${q.dto||'â€”'}</span><span class="badge">${q.mod||'â€”'}</span><span class="badge">Muestra: ${filtered.length}</span>`;
  holder.innerHTML=`
    <div class="qhead"><div class="qnum">${idx+1}.</div><div class="qid">[#${q.id}]</div></div>
    <div class="qtitle">${q.text}</div>
    <div class="answers" id="answers">
      ${['A','B','C','D'].map(L=>`<div class="ans" data-letter="${L}"><b>${L}.</b> ${q[L]||''}</div>`).join('')}
    </div>
    <div class="explain hidden" id="explain"></div>
    <div class="controls"><button id="prev" ${idx===0?'disabled':''}>AtrÃ¡s</button><button id="next" disabled>Siguiente</button></div>`;
  setProgress();
  const list=[...document.querySelectorAll('.ans')], next=$("#next"), prev=$("#prev"), exp=$("#explain"); let answered=false;
  function reveal(letter){ if(answered) return; answered=true; const corr=(q.correct||'').toUpperCase();
    list.forEach(el=>{const l=el.dataset.letter;if(l===corr) el.classList.add('correct'); if(letter&&l===letter&&l!==corr) el.classList.add('wrong');});
    const textoCorrecta=q[corr]?` ${q[corr]}`:''; const textoWhy=q.why?`<br><b>ExplicaciÃ³n:</b> ${q.why}`:''; exp.innerHTML=`<b>Respuesta correcta:</b> ${corr}.${textoCorrecta}${textoWhy}`; exp.classList.remove('hidden'); next.disabled=false;
    if(letter===corr) correct.add(q.id); else wrong.add(q.id); setProgress(); }
  list.forEach(el=> el.onclick=()=>reveal(el.dataset.letter));
  prev.onclick=()=>{if(idx>0){idx--;paint();}}; next.onclick=()=>{if(idx<filtered.length-1){idx++;paint();}else{showSummary();}};
}

/* ======= envÃ­o y resumen con mensajes por % ======= */
function sendResultToSheet(p){const h={"Content-Type":"application/json"};try{return fetch(SHEET_ENDPOINT,{method:"POST",headers:h,body:JSON.stringify(p),mode:"no-cors"}).catch(()=>navigator.sendBeacon(SHEET_ENDPOINT,JSON.stringify(p)));}catch(e){try{navigator.sendBeacon(SHEET_ENDPOINT,JSON.stringify(p));}catch(_){}}}
function resultMessage(percent){
  if (percent < 60) {
    return {
      cls: 'danger',
      title: 'Toca repasar',
      body: 'El resultado estÃ¡ por debajo del 60%. Te recomendamos revisar el blog de procedimientos y los mÃ³dulos con mayor nÃºmero de fallos. Repite el test en 48â€“72 horas: la excelencia se entrena cada dÃ­a.'
    };
  } else if (percent < 90) {
    return {
      cls: 'warn',
      title: 'Vamos bien, pero hay margen de mejora',
      body: 'Buen avance (60â€“89%). Usa â€œRevisar solo falladasâ€, anota dudas y contrÃ¡stalas con el equipo. Un repaso focalizado te llevarÃ¡ rÃ¡pidamente por encima del 90%.'
    };
  } else {
    return {
      cls: 'ok',
      title: 'Â¡Excelente!',
      body: 'MÃ¡s del 90% demuestra dominio y constancia. Gracias a tu esfuerzo, cada dÃ­a reforzamos la calidad del hotel. MantÃ©n la regularidad, ayuda a compaÃ±eros en dudas puntuales y propone mejoras cuando detectes oportunidades.'
    };
  }
}
function showSummary(){
  const d=dept.value||'', m=mod.value||'';
  pushUsedIds(d,m,filtered.map(q=>q.id));
  const dur=Math.round((Date.now()-startTime)/1000);
  const detalleFallos=filtered.map(q=> (wrong.has(q.id)?q.id:null)).filter(Boolean);
  const total=filtered.length, aciertos=correct.size, fallos=wrong.size;
  const pct = total ? Math.round((aciertos/total)*100) : 0;
  const msg = resultMessage(pct);

  const payload={nombre:(who.value||"").trim(),dto:d,modulo:m,nivel:"",total,aciertos,fallos,porcentaje:pct,duracion_seg:dur,detalle_fallos:detalleFallos,user_agent:navigator.userAgent,sitio:location.href};
  sendResultToSheet(payload);

  holder.className="qbox center";
  holder.innerHTML=`<div style="max-width:720px;text-align:left">
      <h3 style="margin:6px 0 10px">Resumen</h3>
      <p class="muted">Aciertos: <b>${aciertos}</b> Â· Fallos: <b>${fallos}</b> Â· Total: <b>${total}</b> Â· <b>${pct}%</b></p>
      <div class="note ${msg.cls}">
        <b>${msg.title}</b>
        ${msg.body}
      </div>
      <div class="controls" style="justify-content:center">
        <button id="review">Revisar solo falladas</button>
        <button id="again" class="primary">Empezar de nuevo</button>
      </div>
    </div>`;
  $("#review").onclick=()=>{const set=new Set([...wrong]); filtered=filtered.filter(q=>set.has(q.id)); idx=0; correct.clear(); wrong.clear(); paint();};
  $("#again").onclick=()=>{idx=0;correct.clear();wrong.clear(); holder.className='qbox center'; holder.innerHTML=document.querySelector('.hero').outerHTML; setProgress();};
}

/* ======= boot con diagnÃ³stico ======= */
(async function boot(){
  const IS_LOCAL = location.protocol==='file:';
  try{
    if(IS_LOCAL){ throw new Error('file:// detectado (fetch CSV bloqueado por navegador)'); }
    const text = await fetchFirst(CSV_CANDIDATES);
    const parsed = parseCSV(text);
    RAW = normalize(parsed);
    log('CSV OK. Filas:', parsed.length, 'Normalizadas:', RAW.length);
    if(!RAW.length){ throw new Error('CSV cargado pero 0 preguntas normalizadas (cabeceras distintas?)'); }
    showWarn('Cargando desde CSV.'); diag.classList.add('hidden');
  }catch(e){
    showWarn(IS_LOCAL ? 'Modo local: usando data.js (fallback).' : 'CSV no disponible: usando data.js (fallback).');
    showDiag(`ðŸ›  DiagnÃ³stico:\n- Motivo: ${e.message}\n- Rutas CSV probadas:\n${CSV_CANDIDATES.map(x=>'  â€¢ '+x).join('\n')}\n- Si usas GitHub Pages, confirma que /data/plantilla_preguntas_unica.csv existe.\n- En local (file://), fetch estÃ¡ bloqueado y se usa data.js.`);
    try{ await loadQUIZFallback(); }
    catch(err){ showDiag(diag.textContent + `\n\nâŒ Fallback data.js fallido:\n- ${err.message}\n- Comprueba: /data/data.js y que defina window.QUIZ.questions[].`); }
  }

  loaded.textContent = RAW.length || 0;

  const depts=[...new Set(RAW.map(x=>x.dto))].filter(Boolean);
  const mods=[...new Set(RAW.map(x=>x.mod))].filter(Boolean);
  dept.innerHTML='<option value="">Todos</option>'+depts.map(v=>`<option>${v}</option>`).join('');
  mod.innerHTML='<option value="">Todos</option>'+mods.map(v=>`<option>${v}</option>`).join('');

  updateKPIs();
})();
</script>
</body>
</html>
