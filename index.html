<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sesión de Crecimiento · Formación</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ --ink:#0f172a; --muted:#64748b; --bg:#f6f7fb; --card:#ffffff; --border:#e5e7eb; --gold:#A58C5F; --accent:#0ea5e9; --ok:#16a34a; --ko:#b91c1c; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1200px;margin:28px auto;padding:0 18px}
  .header{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px 18px;display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center;box-shadow:0 2px 6px rgba(15,23,42,.04)}
  .brand{display:flex;gap:12px;align-items:center}
  .brand img{height:38px;object-fit:contain}
  h1{margin:0;font-weight:800;letter-spacing:.2px;font-size:26px;color:#0b355a}
  .subtitle{margin-top:2px;color:#0f3a77;font-style:italic}
  .toolbar{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr)) auto;gap:12px;margin-top:10px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  select,input[type="text"]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
  button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  button.primary{background:#0b61d6;color:#fff;border:0}
  .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:16px}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:18px}
  .muted{color:var(--muted)}
  #progress{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden}
  #bar{height:100%;width:0%}
  .barok{background:#22c55e}
  .answers{display:grid;gap:8px;margin-top:10px}
  .ans{padding:10px 12px;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:#fff}
  .ans.correct{background:#ecfdf5;border-color:#34d399}
  .ans.wrong{background:#fef2f2;border-color:#fca5a5}
  .hidden{display:none}
  .footer{margin-top:28px;color:var(--muted);font-size:12px;text-align:center}
  .badget{display:inline-block;padding:2px 8px;border-radius:999px;background:#f1f5f9;border:1px solid var(--border);margin-right:6px;font-size:12px}
  .rowflex{display:flex;gap:12px}
  .rowflex>*{flex:1}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fafafa;font-size:12px;margin-right:6px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header card">
      <div class="brand">
        <img src="./img/logo-guadiana.png" alt="Guadiana" onerror="this.style.display='none'">
        <img src="./img/logo-cumbria.png" alt="Cumbria" onerror="this.style.display='none'">
      </div>
      <div>
        <h1>Sesión de Crecimiento · Formación</h1>
        <div class="subtitle">Cuestionario dinámico por departamento, módulo y nivel</div>
        <div class="toolbar">
          <div><label for="dept">Departamento</label><select id="dept"><option value="">—</option></select></div>
          <div><label for="mod">Módulo</label><select id="mod"><option value="">—</option></select></div>
          <div><label for="lvl">Nivel</label><select id="lvl"><option value="">—</option><option>Básico</option><option>Intermedio</option><option>Avanzado</option></select></div>
          <div><label for="who">Participante</label><input id="who" type="text" placeholder="Nombre y apellidos"></div>
          <div style="display:flex;align-items:end"><button id="start" class="primary">Iniciar</button></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div id="progress"><div id="bar" class="barok"></div></div>
        <div id="tally" class="muted">0/0 · 0 aciertos · 0 fallos</div>
        <div id="stage"></div>
        <div id="summary" class="hidden">
          <h3>Resumen</h3>
          <p><span class="pill" id="ok">0</span> aciertos · <span class="pill" id="ko">0</span> fallos · <span class="pill" id="total">0</span> preguntas</p>
          <button id="btnReview">Revisar fallos</button>
          <button id="btnAgain">Empezar de nuevo</button>
        </div>
      </div>
    </div>

    <div class="footer">© Formación interna · GitHub Pages</div>
  </div>

<script>
/* ==================== RUTAS CSV ==================== */
const CSV_CANDIDATES = [
  './data/plantilla_preguntas_unica.csv',
  'data/plantilla_preguntas_unica.csv'
];

/* ==================== UTILS CSV ==================== */
function decodeSmart(buf){
  try{ return new TextDecoder('utf-8',{fatal:false}).decode(buf); }catch(_){}
  try{ return new TextDecoder('windows-1252').decode(buf);}catch(_){}
  return '';
}
function detectDelimiter(sample){
  const counts={',':0,';':0,'\t':0,'|':0};
  const lines=sample.split(/\r?\n/).slice(0,5);
  for(const l of lines){ for(const k in counts){ counts[k]+= (l.split(k).length-1); } }
  let max=-1, best=','; for(const k in counts){ if(counts[k]>max){max=counts[k];best=k;} }
  return best;
}
function splitRow(line,delim){
  const res=[]; let cur='',q=false;
  for(let i=0;i<line.length;i++){
    const c=line[i], n=line[i+1];
    if(c==='\"'){ q=!q; continue; }
    if(!q && c===delim){ res.push(cur); cur=''; continue; }
    if(!q && c==='\r' && n==='\n'){ i++; res.push(cur); return res; }
    if(!q && (c==='\n' || c==='\r')){ res.push(cur); return res; }
    cur+=c;
  }
  res.push(cur); return res;
}
function parseCSV(text){
  const delim = detectDelimiter(text);
  const lines = text.split(/\r?\n/).filter(x=>x.trim()!=='');
  const head  = splitRow(lines[0],delim).map(h=>h.trim().toLowerCase());
  return lines.slice(1).map(ln=>{
    const cols = splitRow(ln,delim);
    const obj = {};
    head.forEach((h,i)=> obj[h] = (cols[i]??'').trim());
    return obj;
  });
}
function normalize(arr){
  const pick=(o,ks)=>{for(const k of ks){ if(k in o && String(o[k]).trim()!=='') return String(o[k]); } return '';};
  return arr.map(r=>{
    const o={}; Object.keys(r).forEach(k=>o[k.toLowerCase()]=r[k]);
    const dto   = pick(o,['dto','departamento','dpto','depto','depart.','departamento (dto)']);
    const mod   = pick(o,['modulo','módulo','module','mod','tema','bloque','unidad','categoria','categoría']);
    const level = pick(o,['nivel','nivél','level']).toLowerCase();
    const text  = pick(o,['text','texto','pregunta','enunciado']);
    const A=pick(o,['a']), B=pick(o,['b']), C=pick(o,['c']), D=pick(o,['d']);
    let corr = (pick(o,['correct_letter','correct','letra_correcta','respuesta_correcta','respuesta'])||'').toUpperCase().match(/[A-D]/)?.[0]||'';
    const why = pick(o,['why','explicacion','explicación','comentario','nota']);
    const activo = pick(o,['activo','activa','enabled']);
    return {id:(pick(o,['id'])||'').trim()||undefined, dto:(dto||'').trim(), mod:(mod||'').trim(), level, text, A,B,C,D, correct:corr, why, activo};
  }).filter(r => r.text && (r.activo==='' || r.activo==='1' || String(r.activo).toLowerCase()==='true'));
}

/* ==================== FALLBACK data.js ==================== */
function loadQUIZFallback(){
  return new Promise((resolve,reject)=>{
    const s=document.createElement('script');
    s.src='./data/data.js?v=' + Date.now();
    s.onload=()=>{
      if(window.QUIZ && Array.isArray(window.QUIZ.questions) && window.QUIZ.questions.length){
        QUESTIONS = window.QUIZ.questions.map(q=>({
          id:q.id, dto:q.departamento||q.dto||'', mod:q.categoria||q.mod||'',
          level:(q.nivel||'').toLowerCase(), text:q.texto||q.text||'',
          A:q.A, B:q.B, C:q.C, D:q.D, correct:(q.correct_letter||q.correct||'').toString().toUpperCase(), why:q.why||''
        })).filter(r=>r.text);
        console.info('[FALLBACK] Cargado desde data.js:', QUESTIONS.length);
        resolve();
      } else { reject(new Error('window.QUIZ vacío')); }
    };
    s.onerror=()=>reject(new Error('No se pudo cargar data.js'));
    document.head.appendChild(s);
  });
}

/* ==================== ESTADO & UI ==================== */
let QUESTIONS=[], filtered=[], idx=0, correct=new Set(), wrong=new Set();
const $=s=>document.querySelector(s);
const dept=$("#dept"), mod=$("#mod"), lvl=$("#lvl"), who=$("#who"), stage=$("#stage");
const bar=$("#bar"), tally=$("#tally"), okEl=$("#ok"), koEl=$("#ko"), totalEl=$("#total");
const summary=$("#summary"), btnReview=$("#btnReview"), btnAgain=$("#btnAgain");

function uniq(arr){ return [...new Set(arr.filter(Boolean))]; }
function progress(){ const pct=filtered.length?((idx+1)/filtered.length)*100:0; bar.style.width=pct.toFixed(1)+"%"; }
function render(){
  if(!filtered.length){ stage.innerHTML='<p class="muted">No hay preguntas con los filtros actuales.</p>'; tally.textContent='0/0 · 0 aciertos · 0 fallos'; bar.style.width='0%'; return; }
  const q=filtered[idx]; progress(); tally.textContent=`${idx+1}/${filtered.length} · ${correct.size} aciertos · ${wrong.size} fallos`;
  stage.innerHTML = `
    <div class="badget">${q.dto||'—'}</div>
    <div class="badget">${q.mod||'—'}</div>
    <div class="badget">${(q.level||'').charAt(0).toUpperCase()+ (q.level||'').slice(1)}</div>
    <h3 style="margin:8px 0 6px">${q.text}</h3>
    <div class="answers">
      ${['A','B','C','D'].map(L=>`<div class="ans" data-letter="${L}"><b>${L}.</b> ${q[L]||''}</div>`).join('')}
    </div>
  `;
  stage.querySelectorAll('.ans').forEach(el=>{
    el.onclick=()=>{
      const letter=el.dataset.letter, corr=String(q.correct||'').toUpperCase();
      const list=[...stage.querySelectorAll('.ans')];
      list.forEach(x=>x.classList.remove('correct','wrong'));
      list.forEach(x=>{ if(x.dataset.letter===corr) x.classList.add('correct'); });
      if(letter===corr){ correct.add(q.id ?? idx); } else { wrong.add(q.id ?? idx); el.classList.add('wrong'); }
      setTimeout(()=>{ if(idx<filtered.length-1){ idx++; render(); } else { showSummary(); } }, 300);
    };
  });
}
function showSummary(){
  stage.innerHTML=''; summary.classList.remove('hidden');
  okEl.textContent=correct.size; koEl.textContent=wrong.size; totalEl.textContent=filtered.length;
}
btnReview.onclick=()=>{
  const set=new Set([...wrong]); filtered = filtered.filter((q,i)=> set.has(q.id ?? i));
  idx=0; correct.clear(); wrong.clear(); summary.classList.add('hidden'); render();
};
btnAgain.onclick=()=>{
  summary.classList.add('hidden'); buildFilters();
};

/* ==================== FILTROS ==================== */
function buildFilters(){
  filtered=[...QUESTIONS];
  const depts=uniq(filtered.map(x=>x.dto)), mods=uniq(filtered.map(x=>x.mod));
  dept.innerHTML='<option value="">—</option>'+depts.map(v=>`<option>${v}</option>`).join('');
  mod.innerHTML ='<option value="">—</option>'+mods.map(v=>`<option>${v}</option>`).join('');
  lvl.value=''; dept.value=''; mod.value=''; idx=0; correct.clear(); wrong.clear();
  render();
}
dept.onchange=()=>{ applyFilters(); };
mod.onchange =()=>{ applyFilters(); };
lvl.onchange =()=>{ applyFilters(); };
function applyFilters(){
  const d=dept.value||'', m=mod.value||'', lv=(lvl.value||'').toLowerCase();
  filtered = QUESTIONS.filter(q=> (d? q.dto===d : true) && (m? q.mod===m : true) && (lv? q.level===lv: true) );
  idx=0; correct.clear(); wrong.clear(); render();
}

/* ==================== AUTO-CARGA ==================== */
async function fetchFirst(urls){
  for (const u of urls){
    try{
      const res = await fetch(u + (u.includes('?')?'&':'?') + 'v=' + Date.now(), { cache:'no-store' });
      if(res.ok){ const buf = await res.arrayBuffer(); return decodeSmart(buf); }
      console.warn('[CSV 404]', u, res.status);
    }catch(e){ console.warn('[CSV ERR]', u, e); }
  }
  throw new Error('CSV no encontrado');
}
async function autoLoad(){
  try{
    const text = await fetchFirst(CSV_CANDIDATES);
    const arr  = parseCSV(text);
    QUESTIONS  = normalize(arr);
    console.info('[CSV] Preguntas cargadas:', QUESTIONS.length);
    if(!QUESTIONS.length){ await loadQUIZFallback(); }
  }catch(err){
    console.warn('[AUTOLOAD] CSV falló, intento fallback data.js', err);
    await loadQUIZFallback().catch(e=>{
      console.error('[FALLBACK] data.js también falló', e);
      alert('No se pudieron cargar preguntas. Revisa la ruta /data del CSV o data.js');
    });
  }
  buildFilters();
}
autoLoad();
</script>
</body>
</html>
