<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sesión de Crecimiento · Formación</title>
<style>
  :root{ --ink:#0f172a; --muted:#64748b; --bg:#f6f7fb; --card:#ffffff; --gold:#A58C5F; --accent:#0ea5e9; --ok:#16a34a; --ko:#b91c1c; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1200px;margin:28px auto;padding:0 18px}
  .header{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:16px;display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;box-shadow:0 2px 6px rgba(15,23,42,.04)}
  h1{margin:0;font-weight:800;letter-spacing:.2px;font-size:26px;color:#0b355a}
  .subtitle{margin-top:2px;color:#0f3a77;font-style:italic}
  .logos{display:flex;gap:18px;align-items:center}
  .logos img{height:42px;object-fit:contain}
  .rule{height:10px;border-radius:999px;background:linear-gradient(90deg,var(--gold),#c8b27f,#60a5fa,#22d3ee);margin-top:8px}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:18px;margin-top:18px}
  @media (max-width:980px){.grid{grid-template-columns:1fr} h1{font-size:22px}}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 2px 6px rgba(15,23,42,.04)}
  .panel{padding:16px}
  label{display:block;font-weight:600;margin:10px 0 6px}
  select,input[type=text]{width:100%;padding:11px;border:1px solid #d0d7e2;border-radius:12px;background:#fff}
  button{padding:11px 14px;border-radius:12px;border:1px solid #d0d7e2;background:#0b1324;color:#fff;font-weight:700;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .muted{color:var(--muted);font-size:14px}
  .progress{height:10px;background:#edf2f7;border-radius:999px;overflow:hidden;margin:8px 0 12px}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#10b981,#059669)}
  .opt{display:block;padding:12px 14px;border:1px solid #e5e7eb;border-radius:14px;margin:10px 0;cursor:pointer;background:#fff}
  .opt.correct{border-color:var(--ok);background:#ecfdf5}
  .opt.wrong{border-color:var(--ko);background:#fef2f2}
  .why{margin-top:10px;padding:12px 14px;border-left:4px solid var(--accent);background:#eff9ff;border-radius:10px;font-weight:600}
  table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #e5e7eb;padding:8px;text-align:left}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;color:#1d2a74;font-weight:700}
  .rowflex{display:flex;gap:12px;flex-wrap:wrap}
  .hint{font-size:12px;color:#475569;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <!-- Cabecera corporativa -->
  <section class="header">
    <div>
      <h1>Sesión de Crecimiento · Formación</h1>
      <div class="subtitle">Enfocada en la Excelencia del Servicio</div>
      <div class="rule"></div>
    </div>
    <div class="logos"><img id="logoG" alt="Sercotel Guadiana" src="./img/logo-guadiana.svg" onerror="this.src='./img/logo-guadiana.png'"></div>
    <div class="logos"><img id="logoC" alt="Cumbria" src="./img/logo-cumbria.svg" onerror="this.src='./img/logo-cumbria.png'"></div>
  </section>

  <div class="grid">
    <aside class="card panel">
      <div class="pill">1) Filtros</div>
      <label for="dept" style="margin-top:6px">Departamento (DTO)</label>
      <select id="dept"><option value="">Todos</option></select>

      <div class="rowflex">
        <div style="flex:1;min-width:160px">
          <label for="mod">Módulo</label>
          <select id="mod"><option value="">—</option></select>
        </div>
        <div style="flex:1;min-width:160px">
          <label for="lvl">Nivel</label>
          <select id="lvl"></select>
        </div>
      </div>
      <div id="availHint" class="hint"></div>

      <div style="margin-top:8px">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="exam30"> <span>Modo examen (30 aleatorias)</span>
        </label>
      </div>

      <hr style="border:0;border-top:1px solid #e5e7eb;margin:14px 0">
      <div class="pill">2) Identificación</div>
      <input id="who" type="text" placeholder="Nombre y apellidos (obligatorio)">
      <div style="margin-top:10px"><button id="start" disabled>Empezar test</button></div>

      <hr style="border:0;border-top:1px solid #e5e7eb;margin:14px 0">
      <h3 style="margin:0 0 8px">Ranking</h3>
      <table id="rank"><thead><tr><th>#</th><th>Nombre</th><th>Módulo</th><th>Nivel</th><th class="right">Aciertos</th><th class="right">% Acierto</th></tr></thead><tbody><tr><td colspan="6" class="muted">Sin resultados todavía.</td></tr></tbody></table>
    </aside>

    <main class="card panel">
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div id="tally" class="muted">0/0 · 0 aciertos · 0 fallos</div>
      <div id="stage"></div>
    </main>
  </div>
</div>

<script>
/* ---------- CSV: rutas válidas para GitHub Pages ---------- */
const CSV_CANDIDATES = (() => {
  const base = location.pathname.replace(/\/[^/]*$/, '');      // /Form.Recep
  return [
    `${base}/data/plantilla_preguntas_unica.csv`,
    './data/plantilla_preguntas_unica.csv',
    'data/plantilla_preguntas_unica.csv'
  ];
})();

/* ===== Estado / utilidades ===== */
let QUESTIONS=[]; let CURRENT=[]; let idx=0, ok=0, bad=0;
const $ = s => document.querySelector(s);
const dept=$("#dept"), mod=$("#mod"), lvl=$("#lvl"), who=$("#who"), startBtn=$("#start");
const stage=$("#stage"), bar=$("#bar"), tally=$("#tally"), rankTbl=document.querySelector('#rank tbody'), examBox=$("#exam30");
const ls={get(){try{return JSON.parse(localStorage.getItem('quiz_rank')||'[]')}catch(_){return[]}},set(x){localStorage.setItem('quiz_rank',JSON.stringify(x))}};
function progress(){ const p=CURRENT.length?Math.round((idx/CURRENT.length)*100):0; bar.style.width=p+'%'; tally.textContent=`${idx}/${CURRENT.length} · ${ok} aciertos · ${bad} fallos`; }
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function refreshRank(){ const rows=ls.get().sort((a,b)=>b.score-a.score).slice(0,25); rankTbl.innerHTML=rows.length?'':'<tr><td colspan="6" class="muted">Sin resultados todavía.</td></tr>'; rows.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${r.name}</td><td>${r.module}</td><td>${r.level}</td><td class="right">${r.hits}/${r.total}</td><td class="right">${Math.round(r.hits*100/r.total)}%</td>`; rankTbl.appendChild(tr); }); }

/* ==== CSV helpers ==== */
function decodeSmart(buf){ let text=new TextDecoder('utf-8',{fatal:false}).decode(buf); const bads=(text.match(/\uFFFD/g)||[]).length; if(bads>5){ try{text=new TextDecoder('windows-1252').decode(buf);}catch(_){}} return text; }
function detectDelimiter(sample){ const counts={',':0,';':0,'\t':0}; let q=false; for(let i=0;i<sample.length&&i<2000;i++){const c=sample[i],n=sample[i+1]; if(c=='"'){ if(n=='"'){i++;} else {q=!q;} continue;} if(!q && counts[c]!=null) counts[c]++; if(c=='\n') break;} let best=',',max=-1; for(const k in counts){ if(counts[k]>max){max=counts[k];best=k;} } return best; }
function splitRow(line,delim){ const res=[]; let cur='',q=false; for(let i=0;i<line.length;i++){const c=line[i],n=line[i+1]; if(q){ if(c=='"'&&n=='"'){cur+='"';i++;} else if(c=='"'){q=false;} else{cur+=c;} } else { if(c=='"'){q=true;} else if(c===delim){res.push(cur);cur='';} else {cur+=c;} } } res.push(cur); return res; }
function parseCSV(text){ const delim=detectDelimiter(text); const rows=text.split(/\r?\n/).filter(l=>l.trim().length); if(!rows.length) return []; const head=splitRow(rows.shift(), delim).map(h=>(h||'').trim().toLowerCase()); return rows.map(line=>{ const cols=splitRow(line,delim); const obj={}; head.forEach((h,i)=>obj[h]=(cols[i]??'')); return obj; }); }
function normalize(arr){
  const pick=(o,ks)=>{for(const k of ks){ if(k in o && String(o[k]).trim()!=='') return String(o[k]); } return '';}
  return arr.map(r=>{
    const o={}; Object.keys(r).forEach(k=>o[k.toLowerCase()]=r[k]);
    const dto=pick(o,['dto','departamento','dpto','depto','depart.','departamento (dto)']);
    const mod=pick(o,['modulo','módulo','module','mod','tema','bloque','unidad','categoria','categoría']);
    const level=pick(o,['nivel','nivél','level']).toLowerCase();
    const text=pick(o,['text','texto','pregunta','enunciado']);
    const A=pick(o,['a']), B=pick(o,['b']), C=pick(o,['c']), D=pick(o,['d']);
    let corr=pick(o,['correct_letter','correct','letra_correcta','respuesta_correcta','respuesta']).toUpperCase().match(/[A-D]/)?.[0]||'';
    const why=pick(o,['why','explicacion','explicación','comentario','nota']);
    const activo=pick(o,['activo','activa','enabled']);
    return { id:(pick(o,['id'])||'').trim()||undefined, dto:(dto||'').trim(), mod:(mod||'').trim(), level, text, A,B,C,D, correct:corr, why, activo };
  }).filter(r=> r.text && (r.activo==='' || r.activo==='1' || (r.activo||'').toString().toLowerCase()==='true'));
}

/* ===== Filtros/UI ===== */
function rowsFor(d,m,l){ let r=QUESTIONS.slice(); if(d) r=r.filter(x=>(x.dto||'').trim()===d); if(m) r=r.filter(x=>(x.mod||'').trim()===m); if(l) r=r.filter(x=>(x.level||'').toLowerCase()===l.toLowerCase()); return r; }
function buildFilters(){
  const depts=[...new Set(QUESTIONS.map(x=>(x.dto||'').trim()).filter(Boolean))].sort();
  dept.innerHTML='<option value="">Todos</option>'+depts.map(d=>`<option>${d}</option>`).join('');
  const mods=[...new Set(QUESTIONS.map(x=>(x.mod||'').trim()).filter(Boolean))].sort();
  mod.innerHTML='<option value="">—</option>'+mods.map(m=>`<option>${m}</option>`).join('');
  const names={basico:'Básico',intermedio:'Intermedio',avanzado:'Avanzado'}, order=['basico','intermedio','avanzado'];
  const byLvl=new Map(); QUESTIONS.forEach(r=>{const k=(r.level||'').trim().toLowerCase(); if(k) byLvl.set(k,(byLvl.get(k)||0)+1);});
  lvl.innerHTML=order.map(k=>`<option value="${k}">${names[k]} (${byLvl.get(k)||0})</option>`).join('');
  updateAvailability();
}
function updateAvailability(){ const available=rowsFor((dept.value||''),(mod.value||''),(lvl.value||'')).length; $('#availHint').textContent=`Preguntas disponibles: ${available}`; startBtn.disabled=!who.value || available===0; }

/* ===== Juego ===== */
function start(){ let pool=rowsFor((dept.value||''),(mod.value||''),(lvl.value||'')); if(!pool.length){ alert('No hay preguntas con esos filtros.'); return; } if($('#exam30').checked){ pool=shuffle(pool.slice()).slice(0,Math.min(30,pool.length)); } CURRENT=pool; idx=0; ok=0; bad=0; show(); }
function show(){ stage.innerHTML=''; if(idx>=CURRENT.length){ const done=document.createElement('div'); done.innerHTML=`<h3>Test completado</h3><p><strong>${who.value}</strong> — ${mod.value||'-'} · ${(lvl.value||'').toUpperCase()}</p><p>Resultado: <strong>${ok}/${CURRENT.length}</strong> (${Math.round(ok*100/CURRENT.length)}%)</p>`; stage.appendChild(done); const rows=ls.get(); rows.push({name:who.value,module:mod.value||'-',level:lvl.value||'-',hits:ok,total:CURRENT.length,score:ok}); ls.set(rows); refreshRank(); return; } const q=CURRENT[idx]; const sec=document.createElement('section'); const h=document.createElement('h3'); h.innerHTML=`${idx+1}. ${q.text}`; h.style.margin='6px 0 8px'; h.style.fontSize='22px'; sec.appendChild(h); ['A','B','C','D'].forEach(K=>{ const t=q[K]; if(!t||!String(t).trim()) return; const btn=document.createElement('div'); btn.className='opt'; btn.dataset.key=K; btn.innerHTML=`<strong>${K}.</strong> ${t}`; btn.onclick=()=>{ Array.from(sec.querySelectorAll('.opt')).forEach(el=> el.onclick=null); const CL=(q.correct||'').toString().toUpperCase().match(/[A-D]/)?.[0]||''; if(K===CL){ btn.classList.add('correct'); ok++; } else { btn.classList.add('wrong'); const c=sec.querySelector(\`.opt[data-key="\${CL}"]\`); if(c) c.classList.add('correct'); bad++; } const next=document.createElement('button'); next.textContent='Siguiente ▶'; next.style.marginTop='10px'; next.onclick=()=>{ idx++; progress(); show(); }; sec.appendChild(next); }; sec.appendChild(btn); }); stage.appendChild(sec); progress(); }

/* ===== Carga con múltiples rutas y diagnóstico en consola ===== */
async function fetchFirst(urls){
  for(const u of urls){
    try{
      const res = await fetch(u + (u.includes('?')?'&':'?') + 'v=' + Date.now(), {cache:'no-store'});
      if(res.ok){ const buf = await res.arrayBuffer(); return decodeSmart(buf); }
      console.warn('[CSV 404]', u, res.status);
    }catch(e){ console.warn('[CSV ERR]', u, e); }
  }
  throw new Error('CSV no encontrado en ninguna ruta candidata');
}
async function autoLoad(){
  const text = await fetchFirst(CSV_CANDIDATES);
  const arr  = parseCSV(text);
  QUESTIONS  = normalize(arr);
  buildFilters();
}

/* ===== Eventos ===== */
dept.addEventListener('change', ()=>{ buildFilters(); });
mod.addEventListener('change',  ()=>{ updateAvailability(); });
lvl.addEventListener('change',  ()=>{ updateAvailability(); });
who.addEventListener('input',   updateAvailability);
document.getElementById('start').addEventListener('click', start);
refreshRank();
autoLoad().catch(err=>{
  console.error(err);
  alert('No se pudo cargar automáticamente el CSV (revisa ruta y nombre exactos en /data).');
});
</script>
</body>
</html>
