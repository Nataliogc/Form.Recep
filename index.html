<script>
const INDEX_PATH = "./data/index.json";
const AGG_BASE = "./data/";

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmtDate = d => new Date(d).toLocaleString('es-ES');
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

let INDEX=null, QUESTIONS=[], pos=0, hits=0, fails=0, currentAnswer=null, currentData=[];

async function loadIndex(){
  const res = await fetch(INDEX_PATH);
  INDEX = await res.json();
  const moduleMap = Object.fromEntries(
    Object.entries(INDEX).filter(([k,v]) => v && v.levels)
      .map(([k,v]) => [k, v.name || k])
  );
  const modSel = $("#moduleSelect");
  modSel.innerHTML = '<option value="">Selecciona mÃ³duloâ€¦</option>' +
    Object.entries(moduleMap).map(([k,name])=>`<option value="${k}">${name}</option>`).join("");
  // Al cambiar mÃ³dulo o nivel, precargo el agg y saco departamentos reales (solo activos)
  modSel.addEventListener("change", preloadAggAndDepartments);
  $("#levelSelect").addEventListener("change", preloadAggAndDepartments);
}
loadIndex().catch(e=>{
  console.error(e);
  $("#status").style.display="block";
  $("#status").textContent="No se pudo cargar el Ã­ndice de datos.";
});

async function preloadAggAndDepartments(){
  const mod = $("#moduleSelect").value;
  const lvl = $("#levelSelect").value;
  const info = INDEX?.[mod]?.levels?.[lvl];
  if(!mod || !info){ return; }
  try{
    const res = await fetch(AGG_BASE + info.agg);
    const all = await res.json();
    currentData = Array.isArray(all) ? all : [];
    // Activo (columna M): 1=activo, 0=inactivo
    const activos = currentData.filter(q => {
      const flag = q.activo ?? q.active ?? q.is_active ?? q.M ?? 1;
      return String(flag).trim() === "1";
    });
    // Departamentos desde DTO/Departamento/Dept/department
    const getDept = q => (q.dto ?? q.departamento ?? q.dept ?? q.department ?? "General").toString().trim();
    const uniq = Array.from(new Set(activos.map(getDept))).filter(Boolean);
    $("#deptSelect").innerHTML =
      '<option value="">Todos los departamentos</option>' +
      uniq.map(d=>`<option value="${d}">${d}</option>`).join("");
  }catch(e){
    console.warn("No se pudo precargar agg:", e);
  }
}

$("#levelSelect").addEventListener("change", e=>{
  const v = e.target.value;
  $("#levelPill").className = "pill " + v;
  $("#levelPill").textContent =
    v==="intermedio" ? "Nivel Intermedio ðŸ”¹" :
    v==="avanzado"   ? "Nivel Avanzado ðŸ”´"   : "Nivel BÃ¡sico ðŸŸ¢";
});
$("#startBtn").addEventListener("click", start);
$("#next").addEventListener("click", nextQ);
$("#finish").addEventListener("click", finishQuiz);
$("#exportBtn").addEventListener("click", exportCSV);

function pick(o, ...keys){ for(const k of keys){ if(o && k in o && o[k]!=null) return o[k]; } return null; }

async function start(){
  const name = $("#playerName").value.trim();
  if(!name){ alert("Escribe tu nombre y apellidos."); return; }
  const mod = $("#moduleSelect").value;
  const lvl = $("#levelSelect").value;
  if(!mod){ alert("Selecciona un mÃ³dulo."); return; }
  const info = INDEX?.[mod]?.levels?.[lvl];
  if(!info){ alert("No hay preguntas para este nivel."); return; }
  // Carga dataset si no estaba precargado
  if(!currentData.length){
    try{ const res = await fetch(AGG_BASE + info.agg); currentData = await res.json(); }
    catch(e){ alert("No se pudo cargar el archivo de preguntas: " + e); return; }
  }
  const deptChosen = $("#deptSelect").value.trim();

  // NormalizaciÃ³n campo a campo (ID, dept, texto, opciones, correcta, explicaciÃ³n, activo)
  const normalize = (q) => {
    const id = pick(q,"id","ID","Id","n","num","numero","NÃºmero") ?? null;
    const dept = (pick(q,"dto","departamento","dept","department") ?? "General").toString().trim();
    const text = pick(q,"text","pregunta","question","q","enunciado") ?? "";
    const opts_raw = pick(q,"options","respuestas","answers","opciones");
    let options = Array.isArray(opts_raw) ? opts_raw : [q.A,q.B,q.C,q.D,q.E,q.F].filter(v=>v!=null);
    let corr = pick(q,"correct","sol","solucion","resultado","answer","Correcta");
    if(typeof corr==="string"){
      const s = corr.trim().toUpperCase();
      if(/^[A-Z]$/.test(s)) corr = s.charCodeAt(0)-65;       // A=>0
      else if(/^\d+$/.test(s)) corr = parseInt(s,10);        // 0..n
      else corr = 0;
    }
    if(typeof corr!=="number") corr = 0;
    const exp = pick(q,"explain","explicacion","explicaciÃ³n","why","razon","L") ?? "";
    const act = pick(q,"activo","active","is_active","M");
    const activo = (act==null) ? 1 : String(act).trim()==="1";
    return { id, dept, text, options, correct: corr, explain: exp, activo };
  };

  let norm = (Array.isArray(currentData)? currentData: []).map(normalize).filter(q=>q.activo);
  if(deptChosen) norm = norm.filter(q => q.dept===deptChosen);
  if(!norm.length){ alert("No hay preguntas activas para el filtro seleccionado."); return; }
  QUESTIONS = norm;

  pos=0; hits=0; fails=0; currentAnswer=null;
  $("#live").style.display="block";
  renderQ();
}

function normalizeCorrect(q){ return clamp(q.correct ?? 0,0,(q.options||[]).length-1); }

function renderQ(){
  const q = QUESTIONS[pos];
  const total = QUESTIONS.length;
  $("#bar").style.width = `${Math.round((pos/total)*100)}%`;
  $("#tally").textContent = `${pos}/${total} Â· ${hits} aciertos Â· ${fails} fallos Â· ${total?Math.round((hits/total)*100):0}%`;
  $("#qId").textContent = `#${(q.id!=null)?q.id:(pos+1)}`;
  $("#qText").textContent = q.text || "(Pregunta)";

  const answers = $("#answers");
  answers.innerHTML = "";
  const correctIdx = normalizeCorrect(q);
  (q.options||[]).forEach((opt, i)=>{
    const row = document.createElement("label");
    row.className = "answer";
    row.innerHTML = `
      <input type="radio" name="ans">
      <span class="letter">${String.fromCharCode(65+i)}</span>
      <span>${opt}</span>
    `;
    row.addEventListener("click", ()=>{
      if(currentAnswer!==null) return;
      currentAnswer = i;
      $$("#answers .answer").forEach(r=>r.classList.remove("correct","incorrect"));
      row.classList.add(i===correctIdx?"correct":"incorrect");
      // ExplicaciÃ³n (columna L)
      const why = $("#why");
      const hasExp = (q.explain && String(q.explain).trim().length);
      if(hasExp){
        why.style.display="block";
        why.className = "explain " + (i===correctIdx?"ok":"bad");
        why.innerHTML = (i===correctIdx?"âœ… Correcto":"âŒ No es correcto") + `<small>${q.explain}</small>`;
      }else{
        why.style.display="none";
        why.className = "explain";
        why.textContent = "";
      }
      $("#next").disabled = false;
      if(pos === QUESTIONS.length-1){ $("#finish").style.display="inline-block"; }
      if(i===correctIdx) hits++; else fails++;
    });
    answers.appendChild(row);
  });

  $("#next").disabled = true;
  $("#finish").style.display = "none";
}

function nextQ(){ if(currentAnswer===null) return; currentAnswer=null; pos++; if(pos>=QUESTIONS.length){ finishQuiz(); return; } renderQ(); }

function finishQuiz(){
  const total = QUESTIONS.length;
  const pct = total? Math.round((hits/total)*100) : 0;
  const box = $("#finalMsg");
  box.style.display = "block";
  box.className = "finalmsg " + (pct>=85?"ok":pct>=60?"warn":"bad");
  box.innerHTML = `<h4>Resultado</h4><p>${hits}/${total} aciertos Â· ${pct}%</p>`;
  const rec = { name: $("#playerName").value.trim(), dept: $("#deptSelect").value || "â€”", module: ($("#moduleSelect").selectedOptions[0]?.textContent)||"â€”", score: pct, date: new Date().toISOString() };
  const key = "quiz_ranking_v1";
  const list = JSON.parse(localStorage.getItem(key)||"[]");
  list.push(rec);
  list.sort((a,b)=>b.score - a.score || new Date(b.date)-new Date(a.date));
  localStorage.setItem(key, JSON.stringify(list.slice(0,100)));
  paintRanking();
}

function paintRanking(){
  const key = "quiz_ranking_v1";
  const list = JSON.parse(localStorage.getItem(key)||"[]");
  const tbody = $("#lbBody");
  if(!list.length){ tbody.innerHTML = `<tr><td colspan="6" class="muted">Sin resultados todavÃ­a.</td></tr>`; return; }
  tbody.innerHTML = list.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${r.name}</td>
      <td>${r.dept||"â€”"}</td>
      <td>${r.module||"â€”"}</td>
      <td>${r.score}%</td>
      <td>${fmtDate(r.date)}</td>
    </tr>
  `).join("");
}
paintRanking();

function exportCSV(){
  const key = "quiz_ranking_v1";
  const list = JSON.parse(localStorage.getItem(key)||"[]");
  if(!list.length){ alert("No hay datos en el ranking."); return; }
  const head = ["#", "Nombre", "Dept.", "MÃ³dulo", "PuntuaciÃ³n", "Fecha"];
  const rows = list.map((r,i)=>[i+1, r.name, r.dept||"", r.module||"", r.score, fmtDate(r.date)]);
  const csv = [head, ...rows].map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\r\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ranking_quiz.csv";
  document.body.appendChild(a); a.click(); a.remove();
}
</script>
